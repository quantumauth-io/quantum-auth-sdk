{"version":3,"sources":["../src/index.ts","../src/constants/index.ts"],"sourcesContent":["// packages/node/src/index.ts\nimport {\n    QUANTUMAUTH_SERVER_URL,\n    QUANTUMAUTH_VERIFICATION_PATH,\n} from \"./constants\";\n\nimport type { Request, Response, NextFunction, RequestHandler } from \"express\";\n\nexport * from \"./constants\";\n\nexport interface QuantumAuthNodeConfig {\n    backendApiKey?: string;\n    timeoutMs?: number;\n}\n\nexport interface VerificationRequestPayload {\n    method: string;\n    path: string;\n    headers: Record<string, string>;\n}\n\nexport interface VerificationResponse {\n    authenticated: boolean;\n    userId?: string;\n    payload?: unknown; // decrypted payload\n    error?: string;\n}\n\nexport interface QuantumAuthContext {\n    userId: string;\n    payload: unknown;\n}\n\n// Express request shape after QuantumAuth middleware\nexport interface QuantumAuthRequest extends Request {\n    userId?: string;\n    quantumAuth?: QuantumAuthContext;\n    qa?: QuantumAuthContext;\n}\n\n\ntype VerifyResponseBody = {\n    authenticated?: boolean;\n    user_id?: string;\n    userId?: string;\n    payload?: unknown;\n    data?: unknown;\n    error?: string;\n};\n\nexport async function verifyRequestWithServer(\n    cfg: QuantumAuthNodeConfig,\n    input: VerificationRequestPayload,\n): Promise<VerificationResponse> {\n    const url = joinUrl(QUANTUMAUTH_SERVER_URL, QUANTUMAUTH_VERIFICATION_PATH);\n\n    const controller = new AbortController();\n    const timeout = setTimeout(\n        () => controller.abort(),\n        cfg.timeoutMs ?? 3000,\n    );\n\n    try {\n        const headers: Record<string, string> = {\n            \"Content-Type\": \"application/json\",\n        };\n\n        if (cfg.backendApiKey) {\n            headers[\"X-QuantumAuth-Backend-Key\"] = cfg.backendApiKey;\n        }\n\n        const res = await fetch(url, {\n            method: \"POST\",\n            headers,\n            body: JSON.stringify(input),\n            signal: controller.signal,\n        });\n\n        const text = await res.text();\n        let json: VerifyResponseBody | null;\n\n        try {\n            json = text ? (JSON.parse(text) as VerifyResponseBody) : null;\n        } catch {\n            json = null;\n        }\n\n        if (!res.ok) {\n            const errorMessage =\n                json?.error ??\n                `QA server verify failed: HTTP ${res.status} ${res.statusText}`;\n\n            return {\n                authenticated: false,\n                error: errorMessage,\n            };\n        }\n\n        return {\n            authenticated: Boolean(json?.authenticated),\n            userId: json?.user_id ?? json?.userId,\n            payload: json?.payload ?? json?.data,\n        };\n    } catch (err: unknown) {\n        const message =\n            err instanceof Error ? err.message : String(err);\n\n        return {\n            authenticated: false,\n            error: message,\n        };\n    } finally {\n        clearTimeout(timeout);\n    }\n}\n\nexport function createExpressQuantumAuthMiddleware(\n    cfg: QuantumAuthNodeConfig,\n): RequestHandler {\n    return async function quantumAuthMiddleware(\n        req: QuantumAuthRequest,\n        res: Response,\n        next: NextFunction,\n    ): Promise<void> {\n        try {\n            const encrypted = req.body;\n\n            if (encrypted == null) {\n                res\n                    .status(400)\n                    .json({ error: \"Missing request body for QuantumAuth\" });\n                return;\n            }\n\n            const method = req.method;\n            const path = req.originalUrl || req.url || \"\";\n\n            const incomingHeaders: Record<string, string> = {};\n            const rawHeaders = req.headers ?? {};\n\n            for (const [key, value] of Object.entries(rawHeaders)) {\n                if (value == null) continue;\n\n                const lower = key.toLowerCase();\n                if (\n                    lower === \"authorization\" ||\n                    lower.startsWith(\"x-quantumauth-\") ||\n                    lower === \"x-qa-signature\"\n                ) {\n                    incomingHeaders[key] = Array.isArray(value)\n                        ? value.join(\",\")\n                        : String(value);\n                }\n            }\n\n            const verifyPayload: VerificationRequestPayload = {\n                method,\n                path,\n                headers: incomingHeaders,\n            };\n            console.log(\"QuantumAuth verify request:\", verifyPayload);\n            const result = await verifyRequestWithServer(cfg, verifyPayload);\n\n            req.userId = result.authenticated && result.userId ? result.userId : undefined;\n\n            const userId = result.userId;\n\n            if (!result.authenticated || !userId) {\n                res.status(401).json({\n                    error: result.error ?? \"QuantumAuth authentication failed\",\n                });\n                return;\n            }\n\n            const ctx: QuantumAuthContext = {\n                userId,\n                payload: result.payload,\n            };\n\n            req.quantumAuth = ctx;\n            req.qa = ctx;\n\n            if (result.payload !== undefined) {\n                // decrypted payload becomes the new body\n                req.body = result.payload as unknown;\n            }\n\n            next();\n        } catch (err: unknown) {\n            const message =\n                err instanceof Error ? err.message : String(err);\n\n            res\n                .status(500)\n                .json({\n                    error: `QuantumAuth middleware error: ${message}`,\n                });\n        }\n    };\n}\n\nexport function joinUrl(base: string, path: string): string {\n    if (!base.endsWith(\"/\") && !path.startsWith(\"/\")) {\n        return base + \"/\" + path;\n    }\n    if (base.endsWith(\"/\") && path.startsWith(\"/\")) {\n        return base + path.slice(1);\n    }\n    return base + path;\n}\n","export const QUANTUMAUTH_ALLOWED_HEADERS = [\n    \"Content-Type\",\n    \"Authorization\",\n    \"X-QuantumAuth-Canonical-B64\"\n] as const;\n\nexport const QUANTUMAUTH_VERIFICATION_PATH: string = \"/quantum-auth/v1/auth/verify\";\nexport const QUANTUMAUTH_SERVER_URL: string = \"https://api.quantumauth.io\";"],"mappings":"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","names":[]}