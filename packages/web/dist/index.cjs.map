{"version":3,"sources":["../src/index.ts","../src/constants/index.ts"],"sourcesContent":["// packages/web/src/index.ts\nimport {clientURL} from \"./constants\";\nexport * from \"./constants\"\nexport interface QuantumAuthWebConfig {\n    backendBaseUrl: string;\n    appId?: string;\n}\n\nexport interface ProtectedCallOptions<TBody = unknown> {\n    method: \"GET\" | \"POST\" | \"PUT\" | \"PATCH\" | \"DELETE\";\n    path: string;\n    body?: TBody;\n}\n\nexport interface ProtectedCallResult<T = unknown> {\n    ok: boolean;\n    status: number;\n    headers: Headers;\n    data: T | null;\n    raw: Response;\n}\n\ninterface ChallengeResponse {\n    qaProof: Record<string, string>;\n}\n\n/**\n * Represents a web client used for managing quantum-authenticated requests to a backend.\n * Responsible for handling challenge-response mechanisms and ensuring secure communication.\n */\nexport class QuantumAuthWebClient {\n    private readonly qaClientBaseUrl: string;\n    private readonly backendBaseUrl: string;\n\n    constructor(cfg: QuantumAuthWebConfig) {\n        this.qaClientBaseUrl = clientURL\n        this.backendBaseUrl = cfg.backendBaseUrl.replace(/\\/+$/, \"\");\n    }\n\n    async request<TResp = unknown, TBody = unknown>(\n        opts: ProtectedCallOptions<TBody>\n    ): Promise<ProtectedCallResult<TResp>> {\n        const challenge = await this.requestChallenge({\n            method: opts.method,\n            path: opts.path,\n            backendHost: this.extractHost(this.backendBaseUrl),\n        });\n        const url = this.backendBaseUrl + opts.path;\n\n        const headers = new Headers({\n            \"Content-Type\": \"application/json\",\n        });\n\n        for (const [k, v] of Object.entries(challenge.qaProof)) {\n            headers.set(k, v);\n        }\n\n        const resp = await fetch(url, {\n            method: opts.method,\n            headers,\n            body:\n                opts.method === \"GET\"\n                    ? undefined\n                    : JSON.stringify(opts.body ?? {}),\n            credentials: \"include\",\n        });\n\n        let data: TResp | null = null;\n        try {\n            const text = await resp.text();\n            data = text ? (JSON.parse(text) as TResp) : null;\n        } catch {\n            data = null;\n        }\n\n        return {\n            ok: resp.ok,\n            status: resp.status,\n            headers: resp.headers,\n            data,\n            raw: resp,\n        };\n    }\n\n    /**\n     * Makes an asynchronous request to get a QA challenge from the qa client.\n     *\n     * @param {Object} params - The parameters required to request the challenge.\n     * @param {string} params.method - The HTTP method used in the challenge request.\n     * @param {string} params.path - The backend API path for which the challenge is requested.\n     * @param {string} params.backendHost - The backend host to authenticate with.\n     * @return {Promise<ChallengeResponse>} A promise that resolves to the challenge response, containing the required proof.\n     * @throws {Error} If the response status indicates a failure or the server returns an error.\n     */\n    private async requestChallenge(params: {\n        method: string;\n        path: string;\n        backendHost: string;\n    }): Promise<ChallengeResponse> {\n        const url = `${this.qaClientBaseUrl}/api/qa/authenticate`;\n        const resp = await fetch(url, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n                method: params.method,\n                path: params.path,\n                backend_host: params.backendHost,\n            }),\n            credentials: \"include\",\n        });\n\n        if (!resp.ok) {\n            const text = await resp.text();\n            throw new Error(`qa challenge failed: ${resp.status} ${text}`);\n        }\n\n        const json = await resp.json();\n\n        return {\n            qaProof: json.headers ?? {},\n\n        };\n    }\n\n    /**\n     * Extracts the host from the given URL string. If the URL is invalid, it attempts to manually parse and extract the host.\n     *\n     * @param {string} url - The URL string from which the host needs to be extracted.\n     * @return {string} The extracted host from the provided URL.\n     */\n    private extractHost(url: string): string {\n        try {\n            const u = new URL(url);\n            return u.host;\n        } catch {\n            return url.replace(/^https?:\\/\\//, \"\").split(\"/\")[0];\n        }\n    }\n}\n","export const clientURL : string  = \"http://localhost:8090\"  as const;"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAO,IAAM,YAAsB;;;AD8B5B,IAAM,uBAAN,MAA2B;AAAA,EAI9B,YAAY,KAA2B;AACnC,SAAK,kBAAkB;AACvB,SAAK,iBAAiB,IAAI,eAAe,QAAQ,QAAQ,EAAE;AAAA,EAC/D;AAAA,EAEA,MAAM,QACF,MACmC;AACnC,UAAM,YAAY,MAAM,KAAK,iBAAiB;AAAA,MAC1C,QAAQ,KAAK;AAAA,MACb,MAAM,KAAK;AAAA,MACX,aAAa,KAAK,YAAY,KAAK,cAAc;AAAA,IACrD,CAAC;AACD,UAAM,MAAM,KAAK,iBAAiB,KAAK;AAEvC,UAAM,UAAU,IAAI,QAAQ;AAAA,MACxB,gBAAgB;AAAA,IACpB,CAAC;AAED,eAAW,CAAC,GAAG,CAAC,KAAK,OAAO,QAAQ,UAAU,OAAO,GAAG;AACpD,cAAQ,IAAI,GAAG,CAAC;AAAA,IACpB;AAEA,UAAM,OAAO,MAAM,MAAM,KAAK;AAAA,MAC1B,QAAQ,KAAK;AAAA,MACb;AAAA,MACA,MACI,KAAK,WAAW,QACV,SACA,KAAK,UAAU,KAAK,QAAQ,CAAC,CAAC;AAAA,MACxC,aAAa;AAAA,IACjB,CAAC;AAED,QAAI,OAAqB;AACzB,QAAI;AACA,YAAM,OAAO,MAAM,KAAK,KAAK;AAC7B,aAAO,OAAQ,KAAK,MAAM,IAAI,IAAc;AAAA,IAChD,QAAQ;AACJ,aAAO;AAAA,IACX;AAEA,WAAO;AAAA,MACH,IAAI,KAAK;AAAA,MACT,QAAQ,KAAK;AAAA,MACb,SAAS,KAAK;AAAA,MACd;AAAA,MACA,KAAK;AAAA,IACT;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,MAAc,iBAAiB,QAIA;AAC3B,UAAM,MAAM,GAAG,KAAK,eAAe;AACnC,UAAM,OAAO,MAAM,MAAM,KAAK;AAAA,MAC1B,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU;AAAA,QACjB,QAAQ,OAAO;AAAA,QACf,MAAM,OAAO;AAAA,QACb,cAAc,OAAO;AAAA,MACzB,CAAC;AAAA,MACD,aAAa;AAAA,IACjB,CAAC;AAED,QAAI,CAAC,KAAK,IAAI;AACV,YAAM,OAAO,MAAM,KAAK,KAAK;AAC7B,YAAM,IAAI,MAAM,wBAAwB,KAAK,MAAM,IAAI,IAAI,EAAE;AAAA,IACjE;AAEA,UAAM,OAAO,MAAM,KAAK,KAAK;AAE7B,WAAO;AAAA,MACH,SAAS,KAAK,WAAW,CAAC;AAAA,IAE9B;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQQ,YAAY,KAAqB;AACrC,QAAI;AACA,YAAM,IAAI,IAAI,IAAI,GAAG;AACrB,aAAO,EAAE;AAAA,IACb,QAAQ;AACJ,aAAO,IAAI,QAAQ,gBAAgB,EAAE,EAAE,MAAM,GAAG,EAAE,CAAC;AAAA,IACvD;AAAA,EACJ;AACJ;","names":[]}